<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenic Stay Booking</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <style>
        /* ... (previous styles remain unchanged) ... */

        .fully-booked {
            background-color: #f1c40f;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <!-- ... (body content remains unchanged) ... -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.0/pikaday.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pikaday/1.8.0/css/pikaday.min.css">
    <script>
        let bookings = [];
        const bookingForm = document.getElementById('bookingForm');
        const bookingList = document.getElementById('bookingList');
        const calendarContainer = document.getElementById('calendarContainer');
        const errorMessage = document.getElementById('errorMessage');
        const MAX_BOOKINGS_PER_DAY = 15;

        const today = new Date();
        const threeMonthsLater = new Date(today.getFullYear(), today.getMonth() + 3, today.getDate());

        const startDatePicker = new Pikaday({
            field: document.getElementById('startDate'),
            minDate: today,
            maxDate: threeMonthsLater,
            onSelect: function() {
                endDatePicker.setMinDate(this.getDate());
            }
        });

        const endDatePicker = new Pikaday({
            field: document.getElementById('endDate'),
            minDate: today,
            maxDate: threeMonthsLater
        });

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const startDate = startDatePicker.getDate();
            const endDate = endDatePicker.getDate();

            if (bookings.some(booking => booking.name === name)) {
                errorMessage.textContent = "A booking with this name already exists. Please use a different name.";
                return;
            }

            if (!isBookingAvailable(startDate, endDate)) {
                errorMessage.textContent = "Sorry, one or more days in your selected range are fully booked. Please choose different dates.";
                return;
            }

            addBooking(name, startDate, endDate);
            updateDisplay();
            bookingForm.reset();
            errorMessage.textContent = "";
        });

        function isBookingAvailable(startDate, endDate) {
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                if (getBookingsForDay(currentDate).length >= MAX_BOOKINGS_PER_DAY) {
                    return false;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return true;
        }

        function addBooking(name, startDate, endDate) {
            const color = getRandomColor();
            bookings.push({name, startDate, endDate, color});
        }

        function updateDisplay() {
            bookingList.innerHTML = bookings.map(booking => `
                <div class="booking-item">
                    <div style="display: flex; align-items: center;">
                        <div class="booking-color" style="background-color: ${booking.color};"></div>
                        <span class="booking-name">${booking.name}</span>
                    </div>
                    <span class="booking-dates">${booking.startDate.toDateString()} to ${booking.endDate.toDateString()}</span>
                </div>
            `).join('');

            renderCalendar();
        }

        function renderCalendar() {
            const months = getMonthsBetweenDates(today, threeMonthsLater);
            calendarContainer.innerHTML = months.map(month => {
                const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();
                const firstDay = new Date(month.getFullYear(), month.getMonth(), 1).getDay();
                
                let calendarHTML = `
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th colspan="7">${month.toLocaleString('default', { month: 'long', year: 'numeric' })}</th>
                            </tr>
                            <tr>
                                ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                `;

                let dayCount = 1;
                for (let i = 0; i < 6; i++) {
                    calendarHTML += '<tr>';
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDay || dayCount > daysInMonth) {
                            calendarHTML += '<td></td>';
                        } else {
                            const currentDate = new Date(month.getFullYear(), month.getMonth(), dayCount);
                            const dayBookings = getBookingsForDay(currentDate);
                            const occupancy = dayBookings.length;
                            const isFullyBooked = occupancy >= MAX_BOOKINGS_PER_DAY;
                            let occupancyBars = '';
                            dayBookings.forEach((booking, index) => {
                                const height = 100 / Math.min(occupancy, MAX_BOOKINGS_PER_DAY);
                                occupancyBars += `<div class="occupancy-bar" style="height: ${height}%; background-color: ${booking.color}; bottom: ${index * height}%;"></div>`;
                            });

                            calendarHTML += `
                                <td class="calendar-day ${isFullyBooked ? 'fully-booked' : ''}">
                                    <div class="day-number">${dayCount}</div>
                                    ${occupancyBars}
                                    ${occupancy > 0 ? `<div class="occupancy-number">${occupancy}${isFullyBooked ? ' (Full)' : ''}</div>` : ''}
                                </td>
                            `;
                            dayCount++;
                        }
                    }
                    calendarHTML += '</tr>';
                    if (dayCount > daysInMonth) break;
                }

                calendarHTML += '</tbody></table>';
                return calendarHTML;
            }).join('');
        }

        function getBookingsForDay(date) {
            return bookings.filter(booking => 
                date >= booking.startDate && date <= booking.endDate
            );
        }

        function getMonthsBetweenDates(startDate, endDate) {
            const months = [];
            let currentDate = new Date(startDate.getFullYear(), startDate.getMonth(), 1);
            while (currentDate <= endDate) {
                months.push(new Date(currentDate));
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            return months;
        }

        // Initial render
        renderCalendar();
    </script>
</body>
</html>